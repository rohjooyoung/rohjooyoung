import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import confusion_matrix, classification_report
import matplotlib.pyplot as plt
import shap


rfc = RandomForestClassifier(class_weight='balanced', max_depth=19,  max_features='log2', min_samples_leaf=8,
                       min_samples_split=7, n_estimators=162, random_state=0)

data = pd.read_excel('antifungal_less_than_DP25.xlsx')
X = data.drop(columns=['MIC_64'])
Y = data['MIC_64']


#data = pd.read_excel('antifungal_dataset_simple.xlsx')
#X = data.drop(columns=['MIC_64'])
#Y = data['MIC_64']
print(X)
print(Y)

# Standardize data
sc = StandardScaler()
X_scaled = sc.fit_transform(X)
X_scaled = pd.DataFrame(X_scaled, columns = X.columns, index = X.index.values.tolist())

pearson = X_scaled.corr("pearson")

pd.set_option('display.max_columns', None)
print(pearson)

# Split data
X_train, X_test, Y_train, Y_test = train_test_split(X_scaled, Y, test_size=0.3, random_state=0, stratify= Y)

rfc = rfc.fit(X_train,Y_train.values.ravel())
Y_pred = rfc.predict(X_test)
cm = confusion_matrix(Y_test, Y_pred)
TN, FP, FN, TP = cm.ravel()
print("True Positive: ", TP)
print("True Negative: ", TN)
print("False Positive: ", FP)
print("False Negative: ", FN)
report = classification_report(Y_test, Y_pred, target_names=["Bad", "Good"])

shap.initjs()

print(X.columns)
explainer = shap.TreeExplainer(rfc, X_scaled)
shap_values = explainer.shap_values(X_scaled, check_additivity=False)
print(shap_values)


mean_abs_shap_values = np.mean(np.abs(shap_values), axis=0)
mean_shap_values_df_bad = pd.DataFrame({'Feature': X.columns, 'MeanAbsSHAP_Bad': mean_abs_shap_values[:,0]})

# Sort values in descending order
mean_shap_values_df_bad = mean_shap_values_df_bad.sort_values(by='MeanAbsSHAP_Bad', ascending=False)
# Create bar plot
plt.figure(figsize=(70, 60))
plt.bar(mean_shap_values_df_bad['Feature'], mean_shap_values_df_bad['MeanAbsSHAP_Bad'], color='red')
plt.xlabel('Mean |SHAP value|', size = 80)
plt.ylabel('Feature', size = 80)
plt.yticks(size = 50)
plt.xticks(rotation = 20, ha = "right", size = 60)
plt.title('Feature Importance - Mean Absolute SHAP Values (bad)', size = 80)
plt.autoscale()
plt.show()

# Top ten most important features that influence SHAP for MIC64 = Cat1
index_of_cLogP_predicted = data.columns.get_loc('cLogP_predicted')
index_of_branched_group = data.columns.get_loc('hydrophobic_group_is_branched')
index_of_cyclic_group = data.columns.get_loc('hydrophobic_group_is_cyclic')
index_of_DP = data.columns.get_loc('DP')
index_of_hydrophilic = data.columns.get_loc('Total_hydrophilic_composition')
index_of_hydrophobic = data.columns.get_loc('Total_hydrophobic_composition')
index_of_cationic = data.columns.get_loc('Total_cationic_composition')
index_of_multiarm = data.columns.get_loc('is_multiarm')

Y_multiarm = shap_values[:,index_of_multiarm][:,0]
X_multiarm = X['is_multiarm']

# Most important feature DP
Y_cationic = shap_values[:,index_of_cationic][:,0]
X_cationic = X['Total_cationic_composition']

#plt.scatter(X_DP, Y_DP, color = 'red', s = 10)
#plt.xlabel('DP')
#plt.ylabel('SHAP value (Bad)')
#plt.title('The relationship between SHAP value (Bad) and DP')

# 2nd important feature hydrophilic composition
#plt.scatter(X_hydrophilic_composition, Y_hydrophilic_composition, color = 'red', s = 10)
#plt.xlabel('Hydrophilic composition')
#plt.ylabel('SHAP value (Bad)')
#plt.title('The relationship between SHAP value (Bad) and hydrophilic composition')
Y_hydrophobic = shap_values[:,index_of_hydrophobic][:,0]
X_hydrophobic = X['Total_hydrophobic_composition']

Y_hydrophilic = shap_values[:,index_of_hydrophilic][:,0]
X_hydrophilic = X['Total_hydrophilic_composition']

Y_DP = shap_values[:,index_of_DP][:,0]
X_DP = X['DP']

Y_cyclic = shap_values[:,index_of_cyclic_group][:,0]
X_cyclic = X['hydrophobic_group_is_cyclic']

# 3rd important feature cLogP

Y_cLogP_predicted_bad = shap_values[:,index_of_cLogP_predicted][:,0]
X_cLogP_predicted = X['cLogP_predicted']

Y_hydrophobic_group_is_branched = shap_values[:,index_of_branched_group][:,0]
X_hydrophobic_group_is_branched = X['hydrophobic_group_is_branched']


fig, axes = plt.subplots(nrows=2, ncols=2, figsize=(12, 9))
# plot on each of the subplots
axes[0, 0].scatter(X_hydrophilic, Y_hydrophilic,color = 'red', s=10)
axes[0, 0].set_xlabel('Hydrophilic_composition',fontsize=15)
axes[0, 0].axhline(y=0, color='k', linestyle='dotted')

axes[0, 1].scatter(X_cLogP_predicted, Y_cLogP_predicted_bad,color = 'red', s=10)
axes[0, 1].set_xlabel('cLogP_predicted',fontsize=15)
axes[0, 1].axhline(y=0, color='k', linestyle='dotted')

axes[1, 0].scatter(X_hydrophobic, Y_hydrophobic,color = 'red', s=10)
axes[1, 0].set_xlabel('Hydrophobic_composition',fontsize=15)
axes[1, 0].axhline(y=0, color='k', linestyle='dotted')

axes[1, 1].scatter(X_cationic, Y_cationic,color = 'red', s=10)
axes[1, 1].set_xlabel('Total_cationic_composition',fontsize=15)
axes[1, 1].axhline(y=0, color='k', linestyle='dotted')

# set overall title and adjust subplot spacing
plt.subplots_adjust(hspace=0.4, wspace=0.3)
#fig.text(0.5, 0.03, 'feature values', ha'center', va='center', fontsize=14)
fig.text(0.03, 0.5, 'SHAP values Class0: MIC>64', ha='center', va='center', rotation='vertical', fontsize=14)
plt.show()

plt.scatter(X_DP, Y_DP, color = 'red', s=10)
plt.xlabel('DP',fontsize=10)
plt.xticks(fontsize=8)
plt.ylabel('SHAP values Class0: MIC>64',fontsize=10)
plt.yticks(fontsize=8)
plt.axhline(y=0, color='k', linestyle='dotted')
plt.autoscale()
plt.show()

plt.scatter(X_multiarm, Y_multiarm, color = 'red', s=10)
plt.xlabel('is_multiarm',fontsize=15)
plt.axhline(y=0, color='k', linestyle='dotted')
plt.show()


good_polymer_1 = shap_values[0]
good_polymer_2 = shap_values[1]
good_polymer_3 = shap_values[3]
good_polymer_4 = shap_values[4]
good_polymer_5 = shap_values[5]
good_polymer_6 = shap_values[6]
good_polymer_7 = shap_values[7]
good_polymer_8 = shap_values[10]
good_polymer_9 = shap_values[11]
good_polymer_10 = shap_values[21]
good_polymer_11 = shap_values[32]
good_polymer_12 = shap_values[33]
good_polymer_13 = shap_values[34]
good_polymer_14 = shap_values[37]
good_polymer_15 = shap_values[40]
good_polymer_16 = shap_values[43]
good_polymer_17 = shap_values[44]

def plot_good_polymers(index_of_feature):
    plt.scatter([0,1], good_polymer_1[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_2[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_3[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_3[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_4[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_5[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_6[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_7[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_8[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_9[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_10[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_11[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_12[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_13[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_14[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0,1], good_polymer_15[index_of_feature], marker="o", color = 'red', s = 15)
    plt.scatter([0, 1], good_polymer_16[index_of_feature], marker="o", color='red', s=15)
    plt.scatter([0, 1], good_polymer_17[index_of_feature], marker="o", color='red', s=15)


inverse_design_data = pd.read_excel('inverse_design_antifungal.xlsx')
predicted_shap_values = explainer.shap_values(inverse_design_data, check_additivity=False)

design_1 = predicted_shap_values[0]
design_2 = predicted_shap_values[1]

def plot_inverse_designed_polymers(index_of_feature):
    plt.scatter([0, 1], design_1[index_of_feature], color = 'blue', marker="s", s = 5)
    plt.scatter([0, 1], design_2[index_of_feature], color='purple', marker="s", s = 5)

plot_good_polymers(index_of_hydrophilic)
plot_inverse_designed_polymers(index_of_hydrophilic)
plt.xticks([0, 1])
plt.xlabel("MIC category")
plt.ylabel("SHAP value Hydrophilic Composition")
plt.show()

plot_good_polymers(index_of_hydrophobic)
plot_inverse_designed_polymers(index_of_hydrophobic)
plt.xticks([0, 1])
plt.xlabel("MIC category")
plt.ylabel("SHAP value Hydrophobic Composition")
plt.show()

plot_good_polymers(index_of_cLogP_predicted)
plot_inverse_designed_polymers(index_of_cLogP_predicted)
plt.xticks([0, 1])
plt.xlabel("MIC category")
plt.ylabel("SHAP value cLogP_predicted")
plt.show()

plot_good_polymers(index_of_cationic)
plot_inverse_designed_polymers(index_of_cationic)
plt.xticks([0, 1])
plt.xlabel("MIC category")
plt.ylabel("SHAP value Cationic Composition")
plt.show()

plot_good_polymers(index_of_DP)
plot_inverse_designed_polymers(index_of_DP)
plt.xticks([0, 1])
plt.xlabel("MIC category")
plt.ylabel("SHAP value DP")
plt.show()
